# 綠界金流付款結果通知與物流貨態通知

## 這是什麼？
- 串接綠界金流與物流時，需要接收金流的付款結果通知(ReturnURL)與物流的貨態通知(ServerReplyURL)。收到訊息後，要回應字串 "1|OK" 以表示有收到訊息。

- 若是串接全方位金流與物流整合，接收的字串中含有檢查碼(CheckMacValue)，必須以同樣的金鑰計算檢查碼並比對，才能確認發送訊息者的確是綠界，而非假冒；若是串接站內付 2.0 與全方位物流，接收的訊息必須 AES 解密才能得到完整內容。須儲存通知以供備查。

- 本範例能夠接收綠界的付款結果通知與貨態通知，比對檢查碼或 AES 解密，並於回應綠界的同時儲存通知紀錄。

## 如何使用？
### 本地端
- 先於終端機輸入：`node app-returnurl.js` 以啟動伺服器
- 啟動後，將伺服器對外，例如使用 ngrok： `ngrok http 3000`
- 付款結果通知或貨態通知將能記錄於專案資料夾

### 部署於雲端
- (本段落待完成)

## 已完成功能
### 接收訊息
- [x] 可以接收全方位金流的付款結果通知。
- [x] 可以接收站內付 2.0 的付款結果通知。
- [x] 可以接收物流整合的貨態通知。
- [x] 可以接收全方位物流的貨態通知。

### 辨別訊息
- [x] 可以依據收到的訊息，判斷要比對檢查碼，還是進行 AES 解密。
- [x] 若要比對檢查碼，可以判斷演算法使用全方位金流的 SHA256 還是物流整合的 MD5。
- [x] 若要解碼，可以判斷是站內付 2.0 還是全方位物流。

### 處理訊息
- [x] 若收到的訊息含有檢查碼，可以計算並比對檢查碼。
- [x] 若收到訊息含有 AES 加密過的內容，可以解密 AES。

### 回應訊息
- [x] 處理訊息後，若檢查碼比對正確，則回應 1|OK。
- [x] 處理訊息後，若 AES 解密成功，則回應 1|OK。
- [x] 處理訊息後，若檢查碼比對不正確，則回應檢查碼比對不正確。
- [x] 處理訊息後，若 AES 解密失敗，則回應解密失敗。

### 部署伺服器
- [x] 將伺服器部署於網路上(Render.com)。

### 儲存訊息
- [x] 收到的訊息與處理結果能儲存於本地資料庫裡。
- [ ] 收到的訊息與處理結果能儲存於網路資料庫裡(MongoDB Atlas)。

## 延伸閱讀
- 我所有的綠界技術串接文章與示範：[https://medium.com/@roan6903/list/b0325094c59f](https://medium.com/@roan6903/list/b0325094c59f)
- 綠界技術文件 - 全方位金流：[https://developers.ecpay.com.tw/?p=2509](https://developers.ecpay.com.tw/?p=2509)
- 綠界技術文件 - 站內付2.0：[https://developers.ecpay.com.tw/?p=8972](https://developers.ecpay.com.tw/?p=8972)
- 綠界技術文件 - 物流整合：[https://developers.ecpay.com.tw/?p=7380](https://developers.ecpay.com.tw/?p=7380)
- 綠界技術文件 - 全方位物流：[https://developers.ecpay.com.tw/?p=10075](https://developers.ecpay.com.tw/?p=10075)